<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Live Stream</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body, html {
            height: 100%;
            background: #000;
            overflow: hidden;
            position: fixed;
            width: 100%;
        }
        
        #videoPlayer {
            width: 100vw;
            height: 100vh;
            object-fit: contain;
            background: #000;
        }
        
        .play-button {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.7);
            color: white;
            border: none;
            border-radius: 50%;
            width: 80px;
            height: 80px;
            font-size: 30px;
            cursor: pointer;
            z-index: 10;
            display: none;
        }
        
        .play-button:hover {
            background: rgba(0,0,0,0.9);
        }
        
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 18px;
            z-index: 5;
        }
    </style>
</head>
<body>
    <div class="loading" id="loading">Đang tải stream...</div>
    <button class="play-button" id="playButton" onclick="playVideo()">▶</button>
    
    <video id="videoPlayer" muted controls playsinline webkit-playsinline>
        <source src="/hls/live.m3u8" type="application/x-mpegURL">
        Your browser does not support the video tag.
    </video>

    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    <script>
        const video = document.getElementById('videoPlayer');
        const videoSrc = '/hls/live.m3u8';
        const loading = document.getElementById('loading');
        const playButton = document.getElementById('playButton');

        function playVideo() {
            playButton.style.display = 'none';
            video.play().catch(e => {
                console.log('Autoplay prevented:', e);
                playButton.style.display = 'block';
            });
        }

        function hideLoading() {
            loading.style.display = 'none';
        }

        // Detect mobile device
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        
        if (Hls.isSupported()) {
            const hls = new Hls({
                liveSyncDurationCount: 1,
                liveMaxLatencyDurationCount: 3,
                debug: false,
                enableWorker: true,
                lowLatencyMode: true
            });
            
            hls.loadSource(videoSrc);
            hls.attachMedia(video);
            
            hls.on(Hls.Events.MANIFEST_PARSED, function() {
                console.log('HLS manifest loaded successfully');
                hideLoading();
                
                // Try autoplay
                video.play().catch(e => {
                    console.log('Autoplay prevented:', e);
                    if (isMobile) {
                        playButton.style.display = 'block';
                    }
                });
            });
            
            hls.on(Hls.Events.ERROR, function (event, data) {
                console.error('HLS error:', data);
                if (data.fatal) {
                    switch(data.type) {
                        case Hls.ErrorTypes.NETWORK_ERROR:
                            console.log('Network error, trying to recover...');
                            hls.startLoad();
                            break;
                        case Hls.ErrorTypes.MEDIA_ERROR:
                            console.log('Media error, trying to recover...');
                            hls.recoverMediaError();
                            break;
                        default:
                            console.log('Fatal error, destroying HLS instance');
                            hls.destroy();
                            break;
                    }
                }
            });
            
        } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
            video.src = videoSrc;
            video.addEventListener('loadedmetadata', function() {
                hideLoading();
                video.play().catch(e => {
                    console.log('Autoplay prevented:', e);
                    if (isMobile) {
                        playButton.style.display = 'block';
                    }
                });
            });
            video.addEventListener('error', function() {
                hideLoading();
                playButton.style.display = 'block';
            });
        } else {
            hideLoading();
            playButton.style.display = 'block';
        }
        
        // Handle visibility change (pause when tab not visible)
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                video.pause();
            } else {
                video.play().catch(e => console.log('Resume play prevented:', e));
            }
        });
        
        // Prevent fullscreen on mobile
        video.addEventListener('play', function() {
            if (isMobile) {
                // Try to prevent fullscreen
                video.setAttribute('playsinline', 'true');
                video.setAttribute('webkit-playsinline', 'true');
            }
        });
    </script>
</body>
</html>
